name: Update Pull Request Description

on:
  pull_request:
    types: [opened]

jobs:
  update_description:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get Pull Request Comments
        id: get_comments
        run: |
          # Fetch comments from the pull request
          COMMENTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments)

          # Format comments
          FORMATTED_COMMENTS=""
          INDEX=1
          for row in $(echo "${COMMENTS}" | jq -r '.[] | "\(.body) \(.created_at) \(.user.login)"'); do
            COMMENT_BODY=$(echo $row | cut -d' ' -f1-)
            COMMENT_DATE=$(echo $row | cut -d' ' -f2)
            COMMENT_OWNER=$(echo $row | cut -d' ' -f3)
            FORMATTED_COMMENTS+="$INDEX) $COMMENT_BODY $COMMENT_DATE $COMMENT_OWNER\n"
            INDEX=$((INDEX + 1))
          done

          echo "Formatted Comments: $FORMATTED_COMMENTS"
          echo "::set-output name=formatted_comments::$FORMATTED_COMMENTS"

      - name: Set Pull Request Description
        run: |
          # Extract details from the pull request
          OWNER="${{ github.actor }}"
          TITLE="${{ github.event.pull_request.title }}"
          USER_DESCRIPTION="${{ github.event.pull_request.body }}"
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Extract ticket number and short description from the branch name
          TICKET_NUMBER=$(echo "$BRANCH_NAME" | cut -d'-' -f1)
          SHORT_DESCRIPTION=$(echo "$BRANCH_NAME" | cut -d'-' -f2)
          ENVIRONMENT=$(echo "$BRANCH_NAME" | cut -d'-' -f3)

          # Create the new pull request body with a GUI-like format
          PR_BODY="## Pull Request Details\n\n"
          PR_BODY+="**Pull Request Owner:** $OWNER\n\n"
          PR_BODY+="**Pull Request Title:** $TITLE\n\n"
          PR_BODY+="**User Description:**\n$USER_DESCRIPTION\n\n"
          PR_BODY+="**Short Description:** $SHORT_DESCRIPTION\n\n"
          PR_BODY+="**Ticket Number:** $TICKET_NUMBER\n\n"
          PR_BODY+="**Environment:** $ENVIRONMENT\n\n"
          PR_BODY+="**Reviewers:** ${{ toJson(github.event.pull_request.requested_reviewers) }}\n\n"
          PR_BODY+="**Comments:**\n${{ steps.get_comments.outputs.formatted_comments }}\n"

          # Update the pull request body using GitHub API
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.NITESH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} \
            -d "{\"body\": \"$PR_BODY\"}"
